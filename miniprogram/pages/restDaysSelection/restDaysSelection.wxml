<wxs module="util">
module.exports = {
  includes: function(arr, item) {
    if (!arr) return false;
    for (var i = 0; i < arr.length; i++) {
      if (arr[i] === item) {
        return true;
      }
    }
    return false;
  }
}
</wxs>

<wxs module="tools">
  module.exports = {
    formatDate: function(timestamp) {
      var date = getDate(timestamp);
      return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
    }
  }
</wxs>

<view class="page">
  <!-- 自定义导航栏 -->
  <view class="nav-bar" style="padding-top: {{statusBarHeight}}px">
    <view class="nav-bar-inner">
      <view class="back-btn" bindtap="navigateBack">
        <text class="back-arrow"></text>
      </view>
      <text class="nav-title">选择休息时间</text>
      <view class="nav-right">
        <text class="navbar-help" bindtap="showHelpModal">帮助</text>
      </view>
    </view>
  </view>

  <view class="content" scroll-y style="top:{{statusBarHeight + 44}}px">
    <view class="mode-selector">
      <view 
        class="mode-option {{selectionMode === 'week' ? 'active' : ''}}" 
        data-mode="week" 
        bindtap="switchMode">
        <text>按周选择</text>
      </view>
      <view 
        class="mode-option {{selectionMode === 'date' ? 'active' : ''}}" 
        data-mode="date" 
        bindtap="switchMode">
        <text>按日期选择</text>
      </view>
    </view>

    <view class="selection-panel">
      <block wx:if="{{selectionMode === 'week'}}">
        <view class="week-grid">
          <view 
            wx:for="{{days}}" 
            wx:key="value" 
            class="week-day {{util.includes(selectedDays, item.value) ? 'selected' : ''}}"
            data-value="{{item.value}}"
            bindtap="toggleDaySelection">
            <text>{{item.name}}</text>
          </view>
        </view>
        <text class="hint">点击选择固定休息日</text>
      </block>

      <block wx:else>
        <view class="date-picker">
          <van-calendar 
            class="calendar"
            poppable="{{ false }}"
            show-title="{{ false }}"
            show-confirm="{{ false }}"
            color="#07c160"
            type="range"
            min-date="{{minDate}}"
            max-date="{{maxDate}}"
            bind:confirm="onDateSelect"
            default-date="{{dateRange}}"
            style="--calendar-height: {{calendarHeight}}px;"
          />
        </view>
      </block>
    </view>
  </view>

  <view class="footer">
    <button 
      class="confirm-btn" 
      type="primary" 
      bindtap="confirmSelection">
      确认选择
    </button>
  </view>

  <!-- 帮助模态框 -->
  <view wx:if="{{showHelp}}" class="modal-mask" bindtap="hideHelpModal">
    <view class="modal-container" catchtap="preventTap">
      <view class="modal-header">
        <text class="modal-title">休息日选择帮助</text>
      </view>
      <view class="modal-content">
        <text>您可以通过两种方式选择休息日：\n\n</text>
        <text>1. 按周选择：点击您想要休息的固定星期\n\n</text>
        <text>2. 按日期选择：选择特定的日期范围\n\n</text>
        <text>点击确认后，系统将记录您的休息时间设置。</text>
      </view>
      <view class="modal-footer">
        <button class="modal-btn" bindtap="hideHelpModal">我知道了</button>
      </view>
    </view>
  </view>
</view>